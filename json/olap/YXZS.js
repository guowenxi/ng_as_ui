/**
 * Created by pc on 2017/7/3.
 */


app.controller("YXZS",function($scope,$http,$q,$interval,rootUrlProduct,websocketUrl,$rootScope){


	$scope.aaa={ "success":1, "errorCode":null, "message":"", "data":{ "ids":[ null, null, null, null, null, null ], "legends":null, "series":[ 9769.0, 1.0, 18.0, 476.0, 0.0, 569.0 ], "title":"", "xAxis":[ "今日总事件", "执行指令", "紧急事件", "在线人员", "应急处理", "在线车辆" ] } };
	$scope.bbb={
		"success":1,
		"errorCode":null,
		"message":"",
		"data":{
			"ids":[
				null,
				null,
				null,
				null,
				null,
				null,
				null
			],
			"legends":null,
			"series":[
				9767.0,
				463.0,
				572.0,
				18.0,
				160631.0,
				385700.0,
				52.0
			],
			"title":"",
			"xAxis":[
				"当日事件数",
				"在线人员数",
				"在线车辆数",
				"紧急事件数",
				"停车收费金额",
				"行政处罚金额",
				"其它事件数"
			]
		}
	};
	$scope.ccc={
		"success":1,
		"errorCode":null,
		"message":"",
		"data":{
			"ids":[
				null,
				null
			],
			"legends":null,
			"series":[
				1597.0,
				385700.0
			],
			"title":"",
			"xAxis":[
				"结案数",
				"处罚金额"
			]
		}
	};
	$scope.ddd={
		"success":1,
		"errorCode":null,
		"message":"",
		"data":{
			"ids":[
				null,
				null,
				null
			],
			"legends":null,
			"series":[
				68.0,
				16.0,
				2490.0
			],
			"title":"",
			"xAxis":[
				"一般",
				"简易",
				"违停"
			]
		}
	};
	$scope.eee={
		"success":1,
		"errorCode":null,
		"message":"",
		"data":{
			"ids":null,
			"legends":[
				"市容环境2",
				"宣传广告",
				"施工管理",
				"突发事件",
				"街面秩序",
				"智能监控",
				"市政公用设施",
				"道路交通设施",
				"市容环境",
				"园林绿化",
				"违法经营"
			],
			"series":[
				[
					36.0,
					334.0,
					300.0,
					160.0,
					78.0,
					11.0,
					51.0,
					75.0,
					78.0,
					45.0,
					27.0,
					0.0,
					0.0,
					0.0,
					0.0,
					0.0,
					180.0,
					127.0,
					71.0,
					47.0,
					1.0,
					46.0,
					30.0,
					27.0,
					24.0,
					14.0,
					0.0,
					0.0,
					0.0,
					0.0
				],
				[
					6.0,
					104.0,
					171.0,
					111.0,
					69.0,
					1.0,
					34.0,
					44.0,
					51.0,
					31.0,
					17.0,
					0.0,
					0.0,
					0.0,
					0.0,
					0.0,
					51.0,
					71.0,
					58.0,
					49.0,
					1.0,
					29.0,
					19.0,
					27.0,
					28.0,
					15.0,
					0.0,
					0.0,
					0.0,
					0.0
				],
				[
					0.0,
					14.0,
					31.0,
					38.0,
					14.0,
					1.0,
					15.0,
					11.0,
					11.0,
					9.0,
					4.0,
					0.0,
					0.0,
					0.0,
					0.0,
					0.0,
					9.0,
					14.0,
					24.0,
					8.0,
					1.0,
					14.0,
					7.0,
					5.0,
					7.0,
					4.0,
					0.0,
					0.0,
					0.0,
					0.0
				],
				[
					9.0,
					15.0,
					3.0,
					3.0,
					1.0,
					0.0,
					0.0,
					2.0,
					2.0,
					4.0,
					1.0,
					0.0,
					0.0,
					0.0,
					0.0,
					0.0,
					4.0,
					2.0,
					0.0,
					0.0,
					0.0,
					0.0,
					0.0,
					0.0,
					3.0,
					0.0,
					0.0,
					0.0,
					0.0,
					0.0
				],
				[
					41.0,
					561.0,
					624.0,
					376.0,
					163.0,
					11.0,
					138.0,
					185.0,
					242.0,
					141.0,
					94.0,
					0.0,
					0.0,
					0.0,
					0.0,
					1.0,
					256.0,
					281.0,
					202.0,
					98.0,
					6.0,
					136.0,
					87.0,
					97.0,
					78.0,
					55.0,
					0.0,
					0.0,
					0.0,
					0.0
				],
				[
					2.0,
					4.0,
					3.0,
					3.0,
					6.0,
					3.0,
					1.0,
					2.0,
					3.0,
					6.0,
					6.0,
					0.0,
					0.0,
					0.0,
					0.0
				],
				[
					4.0,
					94.0,
					120.0,
					52.0,
					34.0,
					1.0,
					18.0,
					25.0,
					28.0,
					20.0,
					5.0,
					0.0,
					0.0,
					0.0,
					0.0,
					0.0,
					63.0,
					57.0,
					34.0,
					30.0,
					1.0,
					15.0,
					19.0,
					12.0,
					14.0,
					3.0,
					0.0,
					0.0,
					0.0,
					0.0
				],
				[
					5.0,
					364.0,
					384.0,
					216.0,
					111.0,
					1.0,
					71.0,
					97.0,
					89.0,
					57.0,
					11.0,
					0.0,
					0.0,
					0.0,
					0.0,
					0.0,
					249.0,
					217.0,
					137.0,
					87.0,
					1.0,
					69.0,
					63.0,
					44.0,
					44.0,
					8.0,
					0.0,
					0.0,
					0.0,
					0.0
				],
				[
					17.0,
					43.0,
					49.0,
					23.0,
					8.0,
					2.0,
					5.0,
					13.0,
					20.0,
					5.0,
					2.0,
					0.0,
					0.0,
					0.0,
					0.0,
					0.0,
					15.0,
					15.0,
					4.0,
					3.0,
					0.0,
					5.0,
					4.0,
					3.0,
					2.0,
					1.0,
					0.0,
					0.0,
					0.0,
					0.0
				],
				[
					1.0,
					92.0,
					113.0,
					74.0,
					31.0,
					1.0,
					23.0,
					27.0,
					21.0,
					9.0,
					2.0,
					0.0,
					0.0,
					0.0,
					0.0,
					1.0,
					65.0,
					62.0,
					44.0,
					17.0,
					1.0,
					23.0,
					22.0,
					16.0,
					5.0,
					1.0,
					0.0,
					0.0,
					0.0,
					0.0
				],
				[
					0.0,
					2.0,
					0.0,
					4.0,
					1.0,
					0.0,
					1.0,
					0.0,
					1.0,
					1.0,
					1.0,
					0.0,
					0.0,
					0.0,
					0.0
				]
			],
			"title":"",
			"xAxis":[
				"7",
				"8",
				"9",
				"10",
				"11",
				"12",
				"13",
				"14",
				"15",
				"16",
				"17",
				"18",
				"19",
				"20",
				"21"
			]
		}
	};
	$scope.fff={
		"success":1,
		"errorCode":null,
		"message":"",
		"data":{
			"ids":[
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				null
			],
			"legends":null,
			"series":[
				18.0,
				7014.0,
				2532.0,
				119.0,
				42.0,
				0.0,
				0.0,
				26.0,
				0.0
			],
			"title":"",
			"xAxis":[
				"紧急事件",
				"数字城管",
				"执法办案",
				"电话热线",
				"智能报警",
				"行业监管",
				"区级监管",
				"公共服务",
				"人工上报"
			]
		}
	};
	$scope.ggg={
		"success":1,
		"errorCode":null,
		"message":"",
		"data":{
			"ids":[
				null,
				null,
				null
			],
			"legends":null,
			"series":[
				5101.0,
				4430.0,
				3662.0
			],
			"title":"",
			"xAxis":[
				"上报数",
				"立案数",
				"结案数"
			]
		}
	};
	$scope.hhh={
		"success":1,
		"errorCode":null,
		"message":"",
		"data":{
			"ids":null,
			"legends":[
				"上报数",
				"立案数",
				"结案数"
			],
			"series":[
				[
					723.0,
					2009.0,
					1375.0,
					827.0,
					182.0,
					176.0,
					400.0,
					557.0,
					258.0,
					0.0,
					0.0,
					0.0,
					0.0,
					0.0,
					0.0
				],
				[
					623.0,
					1848.0,
					1256.0,
					635.0,
					155.0,
					166.0,
					372.0,
					491.0,
					142.0,
					0.0,
					0.0,
					0.0,
					0.0,
					0.0,
					0.0
				],
				[
					355.0,
					826.0,
					502.0,
					221.0,
					43.0,
					35.0,
					47.0,
					28.0,
					1.0,
					0.0,
					0.0,
					0.0,
					0.0,
					0.0,
					0.0
				]
			],
			"title":"",
			"xAxis":[
				"7",
				"8",
				"9",
				"10",
				"11",
				"12",
				"13",
				"14",
				"15",
				"16",
				"17",
				"18",
				"19",
				"20",
				"21"
			]
		}
	};
	$scope.iii={
		"success":1,
		"errorCode":null,
		"message":"",
		"data":{
			"ids":[
				null,
				null,
				null,
				null,
				null,
				null,
				null
			],
			"legends":null,
			"series":[
				169.0,
				168.0,
				6.0,
				83.0,
				1065.0,
				270.0,
				11.0
			],
			"title":"",
			"xAxis":[
				"雨量站",
				"水位点",
				"积水点",
				"智能井盖",
				"桥隧",
				"渣土",
				"智能视频"
			]
		}
	};
	$scope.jjj={
		"success":1,
		"errorCode":null,
		"message":"",
		"data":{
			"ids":[
				null,
				null,
				null,
				null
			],
			"legends":null,
			"series":[
				71.0,
				44.0,
				63.0,
				0.0
			],
			"title":"",
			"xAxis":[
				"受理数",
				"审批数",
				"办结数",
				"红牌业务"
			]
		}
	};
	$scope.kkk={
		"success":1,
		"errorCode":null,
		"message":"",
		"data":{
			"ids":[
				null,
				null,
				null
			],
			"legends":null,
			"series":[
				38523.0,
				4376.0,
				2484599.0
			],
			"title":"",
			"xAxis":[
				"贴心城管注册用户",
				"信息服务",
				"手机访问量"
			]
		}
	};
	$scope.lll={
		"success":1,
		"errorCode":null,
		"message":"",
		"data":{
			"ids":[
				null,
				null,
				null
			],
			"legends":null,
			"series":[
				119.0,
				2.0,
				50.0
			],
			"title":"",
			"xAxis":[
				"受理数",
				"结案数",
				"在线坐席"
			]
		}
	};
	$scope.mmm={
		"success":1,
		"errorCode":null,
		"message":"",
		"data":{
			"ids":[
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				null
			],
			"legends":null,
			"series":[
				1449.0,
				673.0,
				2708.0,
				38977.52,
				3579.0,
				45953.68,
				1296.0,
				16709.98,
				810.0,
				9930.47,
				2157.0,
				22870.02,
				2905.0,
				4361.64,
				1148.0,
				9838.74,
				695.0,
				11988.87
			],
			"title":"",
			"xAxis":[
				"POS总数",
				"签到POS总数",
				"上城区数量",
				"上城区金额",
				"下城区数量",
				"下城区金额",
				"江干区数量",
				"江干区金额",
				"拱墅区数量",
				"拱墅区金额",
				"西湖区数量",
				"西湖区金额",
				"景区数量",
				"景区金额",
				"下沙区数量",
				"下沙区金额",
				"滨江区数量",
				"滨江区金额"
			]
		}
	};
	$scope.nnn={
		"success":1,
		"errorCode":null,
		"message":"",
		"data":{
			"legends":[],
			"xAxis":[
				"总泊位数",
				"停车总数",
				"空余泊位"
			],
			"series":[
				15298,
				7446,
				7852
			]
		}
	};
	$scope.ooo={
		"success":1,
		"errorCode":null,
		"message":"",
		"data":{
			"ids":null,
			"legends":[
				"车辆",
				"人员"
			],
			"series":[
				[
					468.0,
					539.0,
					542.0,
					523.0,
					561.0,
					624.0,
					595.0,
					554.0,
					517.0,
					561.0,
					572.0,
					0.0,
					0.0,
					0.0,
					0.0
				],
				[
					100.0,
					405.0,
					530.0,
					560.0,
					540.0,
					399.0,
					376.0,
					469.0,
					523.0,
					513.0,
					498.0,
					0.0,
					0.0,
					0.0,
					0.0
				]
			],
			"title":"",
			"xAxis":[
				"7",
				"8",
				"9",
				"10",
				"11",
				"12",
				"13",
				"14",
				"15",
				"16",
				"17",
				"18",
				"19",
				"20",
				"21"
			]
		}
	};



	$('yxzs-bar').find('.list').css({'opacity':'0'});
	setTimeout(function () {
		$('yxzs-bar').find('.list').animate({'opacity':'1'},1500);
	},5100);


	$scope.$on('yxzs',function (data,item) {
		switch (item.type){
			case "animate_on" :
				//$rootScope._ANIMATE_TO()._AN_DOWN(item.module,item.next,item.timeOut);
				//组件背景图动画
				AN_BG('yxzs-bar','0.5');
				$scope.$broadcast('onCHarts',{type:'chartsAnimateDown',name:'yxzs-charts',delay:'1'});
				break;
		}
	});

	var  timer;
	$scope.promiseData=$q.defer();
	$scope.result=[];
	$scope.result.data=[];

	$scope.yxzsCharts=JSON.stringify({
		id:10,
		queryString:' and region_name = "total" '
	});

	$scope.url=rootUrlProduct.query()+"/olap/getOlapData";

	//关闭定时器
	$scope.$on("$destroy",function(data){
		$interval.cancel(timer);
	});

	$http({
		method:'get',
		url:rootUrlProduct.query()+'/olap/getOlapData',
		params:	{
			id:191
			//queryString:' and region_name = "total" '
		}
	}).success(function(_data){
		_data.state=true;
		$scope.promiseData.resolve(_data);
	});


	$scope.load_data=function (data){
		$scope.result.data=[];
		data.xAxis.length = 6;
		angular.forEach(data.xAxis,function(item,index){
			$scope.result.data.push({
				name:data.xAxis[index],
				num:data.series[index]
			})
		});
	};

	$scope.interval_date=function () {
		timer=$interval(function () {
			$http({
				method:'get',
				url:rootUrlProduct.query()+'/olap/getOlapData',
				params:	{
					id:191
					//queryString:' and region_name = "total" '
				}
			}).success(function(_data){
				_data.state=true;
				$scope.load_data(_data.data);
			});
		},5000)
	};

	//$scope.interval_date();


	function AN_NUM(number,fontSize,time) {
		this.selNum=function (n) {
			if(n != '.'){
				 return 0;
			}else{
				return n
			}
		};
		var int , float , length;
		length = number.length;
		var num = 	document.getElementsByClassName('num_an')[0];
		if (number){
			if(number.indexOf('.') >= 0){
				int = number.substring(0,number.indexOf('.'));
				float = number.substring(int+1,number.length);
			};
			for(var n=0;n<length ; n++){
				var span = document.createElement("span");
				span.innerHTML=this.selNum(number[n]);
				span.className="num";
				span.style.color="#000";
				span.style.position="relative";
				span.style.fontSize=fontSize;
				span.style.transition="all 1s";
				num.appendChild(span);
			};
			for(var n=0;n<length ; n++){
				var thisNum = document.getElementsByClassName('num')[n];
				if(thisNum.innerHTML == '.'){
					continue ;
				}
				setInterval(function () {
					thisNum.style.top+=1;
				},100);
				thisNum.innerHTML=parseInt(thisNum.innerHTML)+1;
				thisNum.style.opacity="1";
			};
		}
		console.log(num.innerHTML);
	}
	//AN_NUM("73.1111")


});

app.directive('yxzsBar',function(){
	var obj = {
		//指令在DOM中以什么形式声明; "E"=元素,"A"=属性,"C"=class,"M"=注释 默认为"A"
		restrict : "EA",
		//执行的优先级
		priority : 0 ,
		//true=优先级低于此指令的不生效 false=均生效
		terminal: false,
		//代表所链接HTML文件的字符串地址,也可以是跟template一样的函数
		template : '<ul class="list">' +
		'<li ng-repeat="item in result.data track by $index" class="list-main">' +
		'<div>{{item.name}}</div>' +
		'<div count-up start-val="0" end-val="item.num">{{item.num}}</div>' +
		'</li>' +
		'</ul>' +
		'<div class="num_an">' + '97.<span>00</span></div>' +
		'<charts charts_params="" class="yxzs-charts" charts-style="gauge_stand" url="{{url}}" params="{{yxzsCharts}}"></charts>'+
		'<img style="width:100%;" src="images/olap_charts.png">'
		,
		//true=显示原始标签,false=不显示原始标签
		replace : false,
		//false=继承父作用域,
		//true=表示继承父作用域，并创建自己的作用域（子作用域）,
		// {}=表示创建一个全新的隔离作用域,
		// 内部属性
		// "@" 绑定一个局部 scope 属性到当前 dom 节点的属性值 (单向绑定,向内影响)
		// "=" 通过 directive 的 attr 属性的值在局部 scope 的属性和父 scope 属性名之间建立双向绑定 (双向绑定,同时影响)
		// "&"  提供一种方式执行一个表达式在父 scope 的上下文中。如果没有指定 attr 名称，则属性名称为相同的本地名称                      (绑定事件,事件改变是可以是directive外的改变,内往外传)
		scope : {
		},
		//可以是字符串或者函数 (公共逻辑)
		//字符串可以指定控制器名称
		//函数为自己设定控制器逻辑
		controller : "YXZS",
		link:function (scope,Element,Attrs) {
			var img = $('yxzs-bar').find('img').eq(0);
			img.css({'height':img.width()*0.61/1.4});
			scope.promiseData.promise.then(function (_data) {
				scope.load_data(scope.aaa.data)
			});
		}
	};
	return obj;

});